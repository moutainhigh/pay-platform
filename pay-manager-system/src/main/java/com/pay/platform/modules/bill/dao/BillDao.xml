<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pay.platform.modules.bill.dao.BillDao">

    <select id="queryAgentEveryDayBill" resultType="java.util.Map">
        select tab.create_time , tab.agentName
        ,(
        select IFNULL(sum(tor.order_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_Order_Amount
        ,(
        select IFNULL(sum(tor.actual_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_actual_amount
        ,(
        select IFNULL(sum(tor.handling_fee) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_Handling_Fee
        ,(
        select IFNULL(sum(tor.channel_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_channel_amount
        ,(
        select IFNULL(sum(tor.platform_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_platform_amount
        ,(
        select IFNULL(sum(tor.agent_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_agent_amount
        from (
            select tca.create_time , (
                    select GROUP_CONCAT(tor.platform_order_no)
                    from tb_order tor where TO_DAYS(tor.CREATE_TIME) = TO_DAYS(tca.CREATE_TIME) and tor.pay_status = 'payed'
                    <if test="agentId != null and agentId != '' ">
                        and tor.agent_id = #{agentId}
                    </if>
                ) orderNos
               , (   select tag.agent_name  from tb_agent tag   where tag.id = #{agentId} ) as agentName
            from tb_calendar tca
            where tca.create_time &gt; '2018-12-31 23:59:59' and TO_DAYS(tca.create_time) &lt;= TO_DAYS(now())
        ) tab
        <where>
            <if test="beginTime != null and beginTime != '' ">
                and to_days(tab.create_time) &gt;= to_days(#{beginTime})
            </if>
            <if test="endTime != null and endTime != '' ">
                and to_days(tab.create_time) &lt;= to_days(#{endTime})
            </if>
        </where>

    </select>

    <select id="queryMerchantEveryDayBill" resultType="java.util.Map">
        select tab.create_time , tab.merchantNo
        ,(
            select IFNULL(sum(tor.order_amount) ,0) from tb_order tor
            where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_Order_Amount
        ,(
        select IFNULL(sum(tor.actual_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_actual_amount
        ,(
        select IFNULL(sum(tor.handling_fee) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_Handling_Fee
        ,(
        select IFNULL(sum(tor.channel_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_channel_amount
        ,(
        select IFNULL(sum(tor.platform_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_platform_amount
        ,(
        select IFNULL(sum(tor.agent_amount) ,0) from tb_order tor
        where FIND_IN_SET(tor.platform_order_no,tab.orderNos)
        ) day_agent_amount,
        tab.day_all_order_num,tab.day_payed_order_num
        from (
            select tca.create_time , (
                select GROUP_CONCAT(tor.platform_order_no)
                from tb_order tor where TO_DAYS(tor.CREATE_TIME) = TO_DAYS(tca.CREATE_TIME) and tor.pay_status = 'payed'
                <if test="agentId != null and agentId != '' ">
                    and tor.agent_id = #{agentId}
                </if>
                <if test="merchantId != null and merchantId != '' ">
                    and tor.merchant_id = #{merchantId}
                </if>
            ) orderNos,
             (
                select count(1)
                from tb_order tor where TO_DAYS(tor.CREATE_TIME) = TO_DAYS(tca.CREATE_TIME)
                <if test="agentId != null and agentId != '' ">
                    and tor.agent_id = #{agentId}
                </if>
                <if test="merchantId != null and merchantId != '' ">
                    and tor.merchant_id = #{merchantId}
                </if>
            ) day_all_order_num
            , (
                select count(1)
                from tb_order tor where TO_DAYS(tor.CREATE_TIME) = TO_DAYS(tca.CREATE_TIME) and tor.pay_status = 'payed'
                <if test="agentId != null and agentId != '' ">
                    and tor.agent_id = #{agentId}
                </if>
                <if test="merchantId != null and merchantId != '' ">
                    and tor.merchant_id = #{merchantId}
                </if>
            ) day_payed_order_num
            , (   select tmer.merchant_no  from tb_merchant tmer   where tmer.id = #{merchantId} ) as merchantNo
            from tb_calendar tca
            where tca.create_time &gt; '2018-12-31 23:59:59' and TO_DAYS(tca.create_time) &lt;= TO_DAYS(now())
        ) tab
        <where>
            <if test="beginTime != null and beginTime != '' ">
                and to_days(tab.create_time) &gt;= to_days(#{beginTime})
            </if>
            <if test="endTime != null and endTime != '' ">
                and to_days(tab.create_time) &lt;= to_days(#{endTime})
            </if>
        </where>

    </select>

    <select id="queryBillByDateTime" resultType="java.util.Map">
        select
            IFNULL(sum(tor.order_amount) ,0) as day_Order_Amount , IFNULL(sum(tor.actual_amount) ,0) as day_actual_amount ,
            IFNULL(sum(tor.handling_fee) ,0) as day_Handling_Fee , IFNULL(sum(tor.channel_amount) ,0) as day_channel_amount ,
            IFNULL(sum(tor.platform_amount) ,0)  as day_platform_amount , IFNULL(sum(tor.agent_amount) ,0) as day_agent_amount ,
            count(1) as day_payed_order_num ,
            (   select tmer.merchant_no  from tb_merchant tmer   where tmer.id = #{merchantId} ) as merchantNo ,
            (   select tag.agent_name  from tb_agent tag   where tag.id = #{agentId} ) as agentName ,
           (
              select count(1) from tb_order tor2
              where tor2.CREATE_TIME &gt;= #{beginTime} and tor2.create_time &lt;= #{endTime}
              <if test="agentId != null and agentId != '' ">
                    and tor2.agent_id = #{agentId}
              </if>
              <if test="merchantId != null and merchantId != '' ">
                    and tor2.merchant_id = #{merchantId}
              </if>
            ) as day_all_order_num
        from tb_order tor
        where tor.pay_status = 'payed' and tor.CREATE_TIME &gt;= #{beginTime} and tor.create_time &lt;= #{endTime}
        <if test="agentId != null and agentId != '' ">
            and tor.agent_id = #{agentId}
        </if>
        <if test="merchantId != null and merchantId != '' ">
            and tor.merchant_id = #{merchantId}
        </if>
    </select>

</mapper>